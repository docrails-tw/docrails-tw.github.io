<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rails 路由：深入淺出 — Ruby on Rails 指南</title>

  <meta name="description" content="Ruby on Rails 指南：系統學習 Rails（Rails 4.2 版本）" >
  <meta name="keywords"    content="Ruby Rails Guides 指南 系統 學習 免費 網路 Web 開發" >
  <meta name="author"      content="http://git.io/G_R1sA">

  <meta property="fb:admins"      content="1340181291">
  <meta property="og:title"       content="Ruby on Rails 指南">
  <meta property="og:site_name"   content="Ruby on Rails 指南">
  <meta property="og:image"       content="http://rails.ruby.tw/images/rails_guides_cover.jpg">
  <meta property="og:url"         content="http://rails.ruby.tw/">
  <meta property="og:type"        content="article">
  <meta property="og:description" content="Ruby on Rails 指南：系統學習 Rails（Rails 4.2 版本）">

  <link rel="stylesheet" href="stylesheets/application.css">

  <link href="http://fonts.googleapis.com/css?family=Noto+Sans:400,700|Noto+Serif:700|Source+Code+Pro" rel="stylesheet">

  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多內容 <a href="http://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多內容
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://rubyonrails.org/">綜覽</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/download">下載</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/deploy">部署</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">原始碼</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/screencasts">影片</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/documentation">文件</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/community">社群</a></li>
        <li class="more-info"><a href="http://weblog.rubyonrails.org/">Blog</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">指南目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr>
              <dl class="L">
                <dt>起步走</dt>
                <dd><a href="getting_started.html">Rails 起步走</a></dd>
                <dt>Models</dt>
                <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record 遷移</a></dd>
                <dd><a href="active_record_validations.html">Active Record 驗證</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record 回呼</a></dd>
                <dd><a href="association_basics.html">Active Record 關聯</a></dd>
                <dd><a href="active_record_querying.html">Active Record 查詢</a></dd>
                <dt>Views</dt>
                <dd><a href="layouts_and_rendering.html">Rails 算繪與版型</a></dd>
                <dd><a href="form_helpers.html">Action View 表單輔助方法</a></dd>
                <dt>Controllers</dt>
                <dd><a href="action_controller_overview.html">Action Controller 綜覽</a></dd>
                <dd><a href="routing.html">Rails 路由：深入淺出</a></dd>
              </dl>
              <dl class="R">
                <dt>深入了解</dt>
                <dd><a href="active_support_core_extensions.html">Active Support 核心擴展</a></dd>
                <dd><a href="i18n.html">Rails 國際化 API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer 基礎</a></dd>
                <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                <dd><a href="security.html">Rails 安全指南</a></dd>
                <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                <dd><a href="configuring.html">Rails 應用程式設定</a></dd>
                <dd><a href="command_line.html">Rake 任務與 Rails 命令列工具</a></dd>
                <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">在 Rails 使用 JavaScript</a></dd>
                <dd><a href="constant_autoloading_and_reloading.html">Constant Autoloading and Reloading</a></dd>
                <dt>擴充 Rails</dt>
                <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                <dd><a href="generators.html">客製與新建 Rails 產生器</a></dd>
                <dd><a href="rails_application_templates.html">Rails 應用程式模版</a></dd>
                <dt>貢獻 Ruby on Rails</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">貢獻 Ruby on Rails</a></dd>
                <dd><a href="api_documentation_guidelines.html">API 文件準則</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南準則</a></dd>
                <dt>維護方針</dt>
                <dd><a href="maintenance_policy.html">維護方針</a></dd>
                <dt>發佈記</dt>
                <dd><a href="upgrading_ruby_on_rails.html">升級 Ruby on Rails</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 發佈記</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 發佈記</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 發佈記</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 發佈記</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 發佈記</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 發佈記</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 發佈記</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 發佈記</a></dd>
                <dt>Rails 指南翻譯術語</dt>
                <dd><a href="translation_terms.html">翻譯術語</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="//github.com/docrails-tw/guides">貢獻翻譯</a></li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li><a class="nav-item" href="credits.html">致謝</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南目錄</option>
              <optgroup label="起步走">
                  <option value="getting_started.html">Rails 起步走</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移</option>
                  <option value="active_record_validations.html">Active Record 驗證</option>
                  <option value="active_record_callbacks.html">Active Record 回呼</option>
                  <option value="association_basics.html">Active Record 關聯</option>
                  <option value="active_record_querying.html">Active Record 查詢</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 算繪與版型</option>
                  <option value="form_helpers.html">Action View 表單輔助方法</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 綜覽</option>
                  <option value="routing.html">Rails 路由：深入淺出</option>
              </optgroup>
              <optgroup label="深入了解">
                  <option value="active_support_core_extensions.html">Active Support 核心擴展</option>
                  <option value="i18n.html">Rails 國際化 API</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="security.html">Rails 安全指南</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">Rails 應用程式設定</option>
                  <option value="command_line.html">Rake 任務與 Rails 命令列工具</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">在 Rails 使用 JavaScript</option>
                  <option value="constant_autoloading_and_reloading.html">Constant Autoloading and Reloading</option>
              </optgroup>
              <optgroup label="擴充 Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">客製與新建 Rails 產生器</option>
                  <option value="rails_application_templates.html">Rails 應用程式模版</option>
              </optgroup>
              <optgroup label="貢獻 Ruby on Rails">
                  <option value="contributing_to_ruby_on_rails.html">貢獻 Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API 文件準則</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南準則</option>
              </optgroup>
              <optgroup label="維護方針">
                  <option value="maintenance_policy.html">維護方針</option>
              </optgroup>
              <optgroup label="發佈記">
                  <option value="upgrading_ruby_on_rails.html">升級 Ruby on Rails</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 發佈記</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 發佈記</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 發佈記</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 發佈記</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 發佈記</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 發佈記</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 發佈記</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 發佈記</option>
              </optgroup>
              <optgroup label="Rails 指南翻譯術語">
                  <option value="translation_terms.html">翻譯術語</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide">

  <div id="feature">
    <div class="wrapper">
      <h2>Rails 路由：深入淺出</h2><p>本篇介紹與使用者息息相關的路由功能。</p><p>讀完本篇，您將了解：</p>
<ul>
<li>如何解讀 <code>routes.rb</code> 裡的程式碼。</li>
<li>如何使用推薦的資源式寫法或使用 <code>match</code> 方法來撰寫路由。</li>
<li>Controller 動作可接受的參數有那些。</li>
<li>如何使用路由輔助方法來自動建立路徑與 URL。</li>
<li>路由約束條件與 Rack 端點等進階技巧。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#rails-%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E7%9B%AE%E7%9A%84">Rails 路由器的目的</a>

<ul>
<li><a href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E5%A6%82%E4%BD%95%E5%88%86%E6%B4%BE%E8%AB%8B%E6%B1%82">路由器如何分派請求</a></li>
<li><a href="#%E7%94%A2%E7%94%9F%E8%B7%AF%E5%BE%91%E8%88%87%E7%B6%B2%E5%9D%80">產生路徑與網址</a></li>
</ul>
</li>
<li>
<a href="#%E8%B3%87%E6%BA%90%E5%BC%8F%E8%B7%AF%E7%94%B1%EF%BC%9Arails-%E7%9A%84%E9%A0%90%E8%A8%AD%E8%B7%AF%E7%94%B1">資源式路由：Rails 的預設路由</a>

<ul>
<li><a href="#web-%E4%B8%96%E7%95%8C%E8%A3%A1%E7%9A%84%E8%B3%87%E6%BA%90">Web 世界裡的資源</a></li>
<li><a href="#crud%E3%80%81http-%E5%8B%95%E8%A9%9E%E4%BB%A5%E5%8F%8A%E5%8B%95%E4%BD%9C">CRUD、HTTP 動詞以及動作</a></li>
<li><a href="#%E8%B7%AF%E5%BE%91%E8%88%87-url-%E7%9A%84%E8%BC%94%E5%8A%A9%E6%96%B9%E6%B3%95">路徑與 URL 的輔助方法</a></li>
<li><a href="#%E5%90%8C%E6%99%82%E5%AE%9A%E7%BE%A9%E5%A4%9A%E7%AD%86%E8%B3%87%E6%BA%90">同時定義多筆資源</a></li>
<li><a href="#%E5%96%AE%E6%95%B8%E8%B3%87%E6%BA%90">單數資源</a></li>
<li><a href="#controller-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%96%93%E8%88%87%E8%B7%AF%E7%94%B1">Controller 命名空間與路由</a></li>
<li><a href="#%E5%B5%8C%E5%A5%97%E8%B3%87%E6%BA%90">嵌套資源</a></li>
<li><a href="#routing-concerns">Routing Concerns</a></li>
<li><a href="#%E5%BE%9E%E7%89%A9%E4%BB%B6%E5%BB%BA%E7%AB%8B%E8%B7%AF%E5%BE%91%E8%88%87-url">從物件建立路徑與 URL</a></li>
<li><a href="#%E6%96%B0%E5%A2%9E%E6%9B%B4%E5%A4%9A%E8%B3%87%E6%BA%90%E5%BC%8F%E8%B7%AF%E7%94%B1">新增更多資源式路由</a></li>
</ul>
</li>
<li>
<a href="#%E9%9D%9E%E8%B3%87%E6%BA%90%E5%BC%8F%E8%B7%AF%E7%94%B1">非資源式路由</a>

<ul>
<li><a href="#%E7%B6%81%E5%AE%9A%E5%8F%83%E6%95%B8">綁定參數</a></li>
<li><a href="#%E5%8B%95%E6%85%8B%E7%89%87%E6%AE%B5">動態片段</a></li>
<li><a href="#%E9%9D%9C%E6%85%8B%E7%89%87%E6%AE%B5">靜態片段</a></li>
<li><a href="#%E6%9F%A5%E8%A9%A2%E5%AD%97%E4%B8%B2">查詢字串</a></li>
<li><a href="#%E5%AE%9A%E7%BE%A9%E9%A0%90%E8%A8%AD%E5%80%BC">定義預設值</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E8%B7%AF%E7%94%B1">命名路由</a></li>
<li><a href="#http-%E5%8B%95%E8%A9%9E%E7%B4%84%E6%9D%9F%E6%A2%9D%E4%BB%B6">HTTP 動詞約束條件</a></li>
<li><a href="#%E7%89%87%E6%AE%B5%E7%B4%84%E6%9D%9F">片段約束</a></li>
<li><a href="#%E5%9F%BA%E6%96%BC%E8%AB%8B%E6%B1%82%E7%9A%84%E7%B4%84%E6%9D%9F%E6%A2%9D%E4%BB%B6">基於請求的約束條件</a></li>
<li><a href="#%E9%80%B2%E9%9A%8E%E7%B4%84%E6%9D%9F%E6%A2%9D%E4%BB%B6">進階約束條件</a></li>
<li><a href="#%E8%B7%AF%E7%94%B1%E9%80%9A%E9%85%8D%E7%89%87%E6%AE%B5">路由通配片段</a></li>
<li><a href="#%E8%BD%89%E5%9D%80">轉址</a></li>
<li><a href="#%E8%B7%AF%E7%94%B1%E5%88%B0-rack-%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F">路由到 Rack 應用程式</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-root">使用 <code>root</code></a></li>
<li><a href="#unicode-%E5%AD%97%E5%85%83%E7%9A%84%E8%B7%AF%E7%94%B1">Unicode 字元的路由</a></li>
</ul>
</li>
<li>
<a href="#%E5%AE%A2%E8%A3%BD%E5%8C%96%E8%B3%87%E6%BA%90%E5%BC%8F%E8%B7%AF%E7%94%B1">客製化資源式路由</a>

<ul>
<li><a href="#%E6%8C%87%E5%AE%9A%E4%BD%BF%E7%94%A8%E7%9A%84-controller">指定使用的 Controller</a></li>
<li><a href="#%E6%8C%87%E5%AE%9A%E7%B4%84%E6%9D%9F%E6%A2%9D%E4%BB%B6">指定約束條件</a></li>
<li><a href="#%E8%A6%86%E5%AF%AB%E5%85%B7%E5%90%8D%E8%BC%94%E5%8A%A9%E6%96%B9%E6%B3%95">覆寫具名輔助方法</a></li>
<li><a href="#%E8%A6%86%E5%AF%AB-new-%E8%88%87-edit-%E7%89%87%E6%AE%B5">覆寫 <code>new</code> 與 <code>edit</code> 片段</a></li>
<li><a href="#%E7%B5%A6%E5%85%B7%E5%90%8D%E8%BC%94%E5%8A%A9%E6%96%B9%E6%B3%95%E5%8A%A0%E5%89%8D%E7%B6%B4">給具名輔助方法加前綴</a></li>
<li><a href="#%E9%99%90%E5%88%B6%E5%BB%BA%E7%AB%8B%E5%87%BA%E4%BE%86%E7%9A%84%E8%B7%AF%E7%94%B1">限制建立出來的路由</a></li>
<li><a href="#%E7%BF%BB%E8%AD%AF%E8%B7%AF%E5%BE%91">翻譯路徑</a></li>
<li><a href="#%E8%A6%86%E5%AF%AB%E5%96%AE%E6%95%B8%E5%BD%A2%E5%BC%8F">覆寫單數形式</a></li>
<li><a href="#%E5%9C%A8%E5%B5%8C%E5%A5%97%E8%B3%87%E6%BA%90%E4%B8%AD%E4%BD%BF%E7%94%A8-as-%E9%81%B8%E9%A0%85">在嵌套資源中使用 <code>:as</code> 選項</a></li>
<li><a href="#%E8%A6%86%E5%AF%AB%E5%85%B7%E5%90%8D%E8%B7%AF%E7%94%B1%E5%8F%83%E6%95%B8">覆寫具名路由參數</a></li>
</ul>
</li>
<li>
<a href="#%E6%AA%A2%E6%9F%A5%E8%88%87%E6%B8%AC%E8%A9%A6%E8%B7%AF%E7%94%B1">檢查與測試路由</a>

<ul>
<li><a href="#%E5%88%97%E5%87%BA%E7%8F%BE%E6%9C%89%E7%9A%84%E8%B7%AF%E7%94%B1">列出現有的路由</a></li>
<li><a href="#%E6%B8%AC%E8%A9%A6%E8%B7%AF%E7%94%B1">測試路由</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="rails-路由器的目的">1 Rails 路由器的目的</h3><p>Rails 路由器（router）識別網址，分配給對應的 Controller 動作處理。Rails 路由器同時也可用來產生路徑與網址，避免在 View 裡面用字串來把路徑與網址寫死。</p><h4 id="路由器如何分派請求">1.1 路由器如何分派請求</h4><p>當 Rails 收到如下請求時：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
GET /patients/17

</pre>
</div>
<p>會詢問路由器，匹配的 Controller 動作是那個。若第一筆匹配的路由為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/patients/:id', to: 'patients#show'

</pre>
</div>
<p>則請求會分派給 <code>PatientsController</code> 的 <code>show</code> 動作處理，且 <code>params</code> 裡有 <code>{ id: '17' }</code> 參數。</p><h4 id="產生路徑與網址">1.2 產生路徑與網址</h4><p>Rails 路由器也可以產生路徑與網址。若上例的路由改寫為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/patients/:id', to: 'patients#show', as: 'patient'

</pre>
</div>
<p>且應用程式 Controller 裡有以下程式碼：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
@patient = Patient.find(17)

</pre>
</div>
<p>並有對應的 View：</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= link_to 'Patient Record', patient_path(@patient) %&gt;

</pre>
</div>
<p>則路由器便會給 <code>patient_path(@patient)</code> 產生路徑 <code>/patients/17</code>。這使得程式碼更容易了解。注意，使用路由輔助方法（<code>patient_path</code>）時，無需指定 ID。</p><h3 id="資源式路由：rails-的預設路由">2 資源式路由：Rails 的預設路由</h3><p>資源式路由可替資源式 Controller 快速宣告出所有常見的路由。與其挨個替每個動作（ <code>index</code>、<code>show</code>、<code>new</code>、<code>edit</code>、<code>create</code>、<code>update</code> 以及 <code>destroy</code>）宣告路由，資源式路由宣告一行解決。</p><h4 id="web-世界裡的資源">2.1 Web 世界裡的資源</h4><p>瀏覽器向 Rails 請求頁面時，透過使用具體的 HTTP 動詞，如 <code>GET</code>、<code>POST</code>、<code>PATCH</code>、<code>PUT</code> 以及 <code>DELETE</code>，往 URL 發出請求。每個動詞都是對資源的一種操作。資源式路由將請求對應到 Controller 的動作。</p><p>當 Rails 應用程式收到下面這個請求時：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
DELETE /photos/17

</pre>
</div>
<p>會詢問路由器，路由器會決定該交給那個 Controller 的那個動作處理。若第一筆匹配的路由為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos

</pre>
</div>
<p>Rails 會將請求分派給 <code>PhotosController</code> 的 <code>destroy</code> 方法，且 <code>params</code> 裡有 <code>{ id: '17' }</code> 參數。</p><h4 id="crud、http-動詞以及動作">2.2 CRUD、HTTP 動詞以及動作</h4><p>在 Rails 裡，資源式路由提供 HTTP 動詞、URL、Controller 動作，這三者的對應關係。按照慣例，每個動作會對應到資料庫特定的 CRUD 操作。假設路由檔案裡有一條路由宣告為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos

</pre>
</div>
<p>會建立出七筆不同的路由，皆對應到 <code>PhotosController</code>：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/photos</td>
<td>photos#index</td>
<td>顯示所有圖片</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/new</td>
<td>photos#new</td>
<td>回傳建立新圖片的表單</td>
</tr>
<tr>
<td>POST</td>
<td>/photos</td>
<td>photos#create</td>
<td>建立新圖片</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id</td>
<td>photos#show</td>
<td>顯示特定圖片</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id/edit</td>
<td>photos#edit</td>
<td>回傳編輯圖片的表單</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/photos/:id</td>
<td>photos#update</td>
<td>更新特定圖片</td>
</tr>
<tr>
<td>DELETE</td>
<td>/photos/:id</td>
<td>photos#destroy</td>
<td>刪除特定圖片</td>
</tr>
</tbody>
</table>
<div class="note"><p>因為路由器使用 HTTP 動詞與 URL 來匹配進來的請求，所以可將四個 URL 對應到七種不同的動作。</p></div><div class="note"><p>路由依據宣告的順序來匹配。若在 <code>get 'photos/poll'</code> 之前宣告了 <code>resources :photos</code>，則 <code>show</code> 動作會先匹配到 <code>resources :photos</code>。若想將 <code>get 'photos/poll'</code> 的匹配順序提前，提到 <code>resources :photos</code> 之前即可。</p></div><h4 id="路徑與-url-的輔助方法">2.3 路徑與 URL 的輔助方法</h4><p>新建一筆資源式的路由，同時會給應用程式裡的 Controller 加入一些輔助方法。以 <code>resources :photos</code> 為例，可用的輔助方法有：</p>
<table>
<thead>
<tr>
<th>輔助方法</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>photos_path</code></td>
<td>回傳 <code>/photos</code>
</td>
</tr>
<tr>
<td><code>new_photo_path</code></td>
<td>回傳 <code>/photos/new</code>
</td>
</tr>
<tr>
<td><code>edit_photo_path(:id)</code></td>
<td>回傳 <code>/photos/:id/edit</code> (例如 <code>edit_photo_path(10)</code> 會回傳 <code>/photos/10/edit</code>)</td>
</tr>
<tr>
<td><code>photo_path(:id)</code></td>
<td>回傳 <code>/photos/:id</code> (例如 <code>photo_path(10)</code> 回傳 <code>/photos/10</code>)</td>
</tr>
</tbody>
</table>
<p>這些輔助方法有對應的 <code>*_url</code> 形式（像是 <code>photos_url</code>），<code>*_url</code> 會回傳完整的路徑，包含了主機、埠口以及路徑。</p><h4 id="同時定義多筆資源">2.4 同時定義多筆資源</h4><p>如需同時給多個資源建立路由，可以用一行 <code>resources</code> 宣告完成，可節省些打字的時間：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, :books, :videos

</pre>
</div>
<p>等同於：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos
resources :books
resources :videos

</pre>
</div>
<h4 id="單數資源">2.5 單數資源</h4><p>有些資源無需 ID 便能查詢。舉個例子，希望 <code>/profile</code> 顯示目前登入使用者的個人檔案。可以用單數資源（Singular resource），把 <code>/profile</code>（而不是 <code>/profile/:id</code>）對應到 <code>show</code> 動作：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'profile', to: 'users#show'

</pre>
</div>
<p><code>:to</code> 選項傳入字串要使用 <code>controller#action</code> 的形式，傳入符號會直接對應到動作名稱。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'profile', to: :show

</pre>
</div>
<p>以下這筆單數資源式路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resource :geocoder

</pre>
</div>
<p>會建立出六筆不同的路由，皆對應到 <code>GeocodersController</code>：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/geocoder/new</td>
<td>geocoders#new</td>
<td>回傳建立 <code>geocoder</code> 的表單</td>
</tr>
<tr>
<td>POST</td>
<td>/geocoder</td>
<td>geocoders#create</td>
<td>建立新 <code>geocoder</code>
</td>
</tr>
<tr>
<td>GET</td>
<td>/geocoder</td>
<td>geocoders#show</td>
<td>顯示唯一的 <code>geocoder</code> 資源</td>
</tr>
<tr>
<td>GET</td>
<td>/geocoder/edit</td>
<td>geocoders#edit</td>
<td>回傳編輯 <code>geocoder</code> 的表單</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/geocoder</td>
<td>geocoders#update</td>
<td>更新唯一的 <code>geocoder</code> 資源</td>
</tr>
<tr>
<td>DELETE</td>
<td>/geocoder</td>
<td>geocoders#destroy</td>
<td>刪除 <code>geocoder</code> 資源</td>
</tr>
</tbody>
</table>
<div class="note"><p>有時單數（<code>/account</code>）與複數路由（<code>/accounts/45</code>）想交給同樣的 Controller 處理，或是把單數資源對應到複數 Controller 上。舉個例子，<code>resource :photo</code> 與 <code>resources :photos</code> 同時建立出單數與複數的路由，皆對應到 <code>PhotosController</code>。</p></div><p>單數的資源式路由會產生以下輔助方法：</p>
<table>
<thead>
<tr>
<th>輔助方法</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>new_geocoder_path</code></td>
<td>回傳 <code>/geocoder/new</code>
</td>
</tr>
<tr>
<td><code>edit_geocoder_path</code></td>
<td>回傳 <code>/geocoder/edit</code>
</td>
</tr>
<tr>
<td><code>geocoder_path</code></td>
<td>回傳 <code>/geocoder</code>
</td>
</tr>
</tbody>
</table>
<p>和複數資源的路由相同，皆有對應的 <code>*_url</code> 形式，會回傳完整的路徑，包含了主機、埠口以及路徑。</p><div class="warning"><p>有一個<a href="https://github.com/rails/rails/issues/1769">存在已久的 Bug</a> 導致 <code>form_for</code> 無法自動處理好單數資源。解決辦法是給表單明確指定 URL：</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
form_for @geocoder, url: geocoder_path do |f|

</pre>
</div>
<h4 id="controller-命名空間與路由">2.6 Controller 命名空間與路由</h4><p>有時可能想把一堆 Controllers 放在同個命名空間下管理。最常見的場景是需要把管理用的 Controller 放在 <code>Admin::</code> 命名空間下。首先將這些 Controllers 搬到 <code>app/controllers/admin</code> 資料夾底下，接著在路由裡宣告：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
namespace :admin do
  resources :articles, :comments
end

</pre>
</div>
<p>會給 <code>Articles</code> 與 <code>Comments</code> Controllers 在 <code>Admin::</code> 命名空間下建出路由。比如 <code>Admin::ArticlesController</code>，Rails 會產生以下路由：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>輔助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/admin/articles</td>
<td>admin/articles#index</td>
<td>admin_articles_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/articles/new</td>
<td>admin/articles#new</td>
<td>new_admin_article_path</td>
</tr>
<tr>
<td>POST</td>
<td>/admin/articles</td>
<td>admin/articles#create</td>
<td>admin_articles_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/articles/:id</td>
<td>admin/articles#show</td>
<td>admin_article_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/articles/:id/edit</td>
<td>admin/articles#edit</td>
<td>edit_admin_article_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/admin/articles/:id</td>
<td>admin/articles#update</td>
<td>admin_article_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/admin/articles/:id</td>
<td>admin/articles#destroy</td>
<td>admin_article_path(:id)</td>
</tr>
</tbody>
</table>
<p>若想把路徑拿掉 <code>/admin</code> 前綴，則可以這麼宣告：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope module: 'admin' do
  resources :articles, :comments
end

</pre>
</div>
<p>如只有一筆資源，則可簡寫為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :articles, module: 'admin'

</pre>
</div>
<p>若路由希望是 <code>/admin/articles</code>，但想拿掉 <code>Admin::</code> 的前綴，可以這麼宣告：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope '/admin' do
  resources :articles, :comments
end

</pre>
</div>
<p>如只有一筆資源，則可簡寫為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :articles, path: '/admin/articles'

</pre>
</div>
<p>以上這些例子，若沒有使用 <code>scope</code>，則輔助方法保持不變。看看上面最後一個使用 <code>scope</code> 的例子（與前個表格對比看看那裡不一樣），Rails 會產生以下路由：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>輔助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/admin/articles</td>
<td>articles#index</td>
<td>articles_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/articles/new</td>
<td>articles#new</td>
<td>new_article_path</td>
</tr>
<tr>
<td>POST</td>
<td>/admin/articles</td>
<td>articles#create</td>
<td>articles_path</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/articles/:id</td>
<td>articles#show</td>
<td>article_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/admin/articles/:id/edit</td>
<td>articles#edit</td>
<td>edit_article_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/admin/articles/:id</td>
<td>articles#update</td>
<td>article_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/admin/articles/:id</td>
<td>articles#destroy</td>
<td>article_path(:id)</td>
</tr>
</tbody>
</table>
<div class="info"><p>若需要在 <code>namespace</code> 區塊裡，使用不同的命名空間。可以指定 Controller 的絕對路徑：<code>get '/foo' =&gt; '/foo#index'</code>。</p></div><h4 id="嵌套資源">2.7 嵌套資源</h4><p>資源是其它資源的子資源是很常見的情況。舉例來說，假設應用程式有雜誌與廣告兩個 Model：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Magazine &lt; ActiveRecord::Base
  has_many :ads
end

class Ad &lt; ActiveRecord::Base
  belongs_to :magazine
end

</pre>
</div>
<p>這種關係可以用嵌套路由來描述。在這個情況裡，可以這麼宣告路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :magazines do
  resources :ads
end

</pre>
</div>
<p>上面會建立 <code>MagazinesController</code> 的路由，也會給 <code>AdsController</code> 建立路由。<code>Ad</code> 的路徑裡會需要引用 <code>Magazine</code> 資源：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads</td>
<td>ads#index</td>
<td>顯示特定雜誌的所有廣告</td>
</tr>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads/new</td>
<td>ads#new</td>
<td>回傳給特定雜誌新建廣告的表單</td>
</tr>
<tr>
<td>POST</td>
<td>/magazines/:magazine_id/ads</td>
<td>ads#create</td>
<td>建立屬於特定雜誌的廣告</td>
</tr>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads/:id</td>
<td>ads#show</td>
<td>顯示屬於特定雜誌的廣告</td>
</tr>
<tr>
<td>GET</td>
<td>/magazines/:magazine_id/ads/:id/edit</td>
<td>ads#edit</td>
<td>回傳編輯屬於特定雜誌廣告的表單</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/magazines/:magazine_id/ads/:id</td>
<td>ads#update</td>
<td>更新屬於特定雜誌的廣告</td>
</tr>
<tr>
<td>DELETE</td>
<td>/magazines/:magazine_id/ads/:id</td>
<td>ads#destroy</td>
<td>刪除屬於特定雜誌的廣告</td>
</tr>
</tbody>
</table>
<p>同時這也會建立像是 <code>magazine_ads_url</code> 以及 <code>edit_magazine_ad_path</code> 的路由輔助方法。這些方法可接受 <code>Magazine</code> 的實體作為第一個參數：<code>magazine_ads_url(@magazine)</code>。</p><h5 id="嵌套的限制">2.7.1 嵌套的限制</h5><p>嵌套資源也可以放在其它的嵌套資源裡，譬如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :publishers do
  resources :magazines do
    resources :photos
  end
end

</pre>
</div>
<p>多層嵌套很快的變得很難處理。在這個情況裡，應用程式需要識別像是下面的路由：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
/publishers/1/magazines/2/photos/3

</pre>
</div>
<p>對應的路由輔助方法則變成： <code>publisher_magazine_photo_url</code>，需要指定三層的物件。這個情況已經足夠令人困惑，使得 Jamis Buck 寫出一篇流行的<a href="http://weblog.jamisbuck.org/2007/2/5/nesting-resources">文章</a>，文章總結了好的 Rails 的設計經驗準則：</p><div class="info"><p>嵌套資源永遠不要超過 1 層。</p></div><h5 id="淺層嵌套">2.7.2 淺層嵌套</h5><p>避免多層嵌套的方法之一，是將 Controller 的集合動作放在父資源的作用域底下，這樣可以有階層的概念，但不需要嵌套的成員動作。也就是說，只用最少的資源資訊來表示路由，像是：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :articles do
  resources :comments, only: [:index, :new, :create]
end
resources :comments, only: [:show, :edit, :update, :destroy]

</pre>
</div>
<p>這種做法在有意義的描述路由與深層嵌套之間取得平衡。上例還可以使用 <code>:shallow</code> 選項來簡寫：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :articles do
  resources :comments, shallow: true
end

</pre>
</div>
<p>這種寫法產生的路由與上例相同。也可以對父資源指定 <code>:shallow</code> 選項，則父資源底下的資源都會是淺層嵌套：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :articles, shallow: true do
  resources :comments
  resources :quotes
  resources :drafts
end

</pre>
</div>
<p>另有一個 <code>shallow</code> 方法，建立一個作用域區塊，其中的路由皆是淺層嵌套。以下範例會產生與前例相同的路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
shallow do
  resources :articles do
    resources :comments
    resources :quotes
    resources :drafts
  end
end

</pre>
</div>
<p><code>scope</code> 方法有兩個選項，可以用來客製化淺層路由。<code>:shallow_path</code> 可以在 member path 前加上指定的前綴：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope shallow_path: "sekret" do
  resources :articles do
    resources :comments, shallow: true
  end
end

</pre>
</div>
<p>comments 資源會有下列路由：</p>
<table>
<thead>
<tr>
<th>HTTP Verb</th>
<th>Path</th>
<th>Controller#Action</th>
<th>Named Helper</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/articles/:article_id/comments(.:format)</td>
<td>comments#index</td>
<td>article_comments_path</td>
</tr>
<tr>
<td>POST</td>
<td>/articles/:article_id/comments(.:format)</td>
<td>comments#create</td>
<td>article_comments_path</td>
</tr>
<tr>
<td>GET</td>
<td>/articles/:article_id/comments/new(.:format)</td>
<td>comments#new</td>
<td>new_article_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/sekret/comments/:id/edit(.:format)</td>
<td>comments#edit</td>
<td>edit_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/sekret/comments/:id(.:format)</td>
<td>comments#show</td>
<td>comment_path</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/sekret/comments/:id(.:format)</td>
<td>comments#update</td>
<td>comment_path</td>
</tr>
<tr>
<td>DELETE</td>
<td>/sekret/comments/:id(.:format)</td>
<td>comments#destroy</td>
<td>comment_path</td>
</tr>
</tbody>
</table>
<p><code>:shallow_prefix</code> 選項則是給 named helpers 加上前綴:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope shallow_prefix: "sekret" do
  resources :articles do
    resources :comments, shallow: true
  end
end

</pre>
</div>
<p>comments 資源會有下列路由：</p>
<table>
<thead>
<tr>
<th>HTTP Verb</th>
<th>Path</th>
<th>Controller#Action</th>
<th>Named Helper</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/articles/:article_id/comments(.:format)</td>
<td>comments#index</td>
<td>article_comments_path</td>
</tr>
<tr>
<td>POST</td>
<td>/articles/:article_id/comments(.:format)</td>
<td>comments#create</td>
<td>article_comments_path</td>
</tr>
<tr>
<td>GET</td>
<td>/articles/:article_id/comments/new(.:format)</td>
<td>comments#new</td>
<td>new_article_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/comments/:id/edit(.:format)</td>
<td>comments#edit</td>
<td>edit_sekret_comment_path</td>
</tr>
<tr>
<td>GET</td>
<td>/comments/:id(.:format)</td>
<td>comments#show</td>
<td>sekret_comment_path</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/comments/:id(.:format)</td>
<td>comments#update</td>
<td>sekret_comment_path</td>
</tr>
<tr>
<td>DELETE</td>
<td>/comments/:id(.:format)</td>
<td>comments#destroy</td>
<td>sekret_comment_path</td>
</tr>
</tbody>
</table>
<h4 id="routing-concerns">2.8 Routing Concerns</h4><p>Routing Concerns 允許將常見的路由宣告為可重用的，可在其他資源與路由裡使用。定義一個 Routing Concerns：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
concern :commentable do
  resources :comments
end

concern :image_attachable do
  resources :images, only: :index
end

</pre>
</div>
<p>這些 Concerns 可以在資源裡使用，來避免寫重複的程式碼，以及讓路由之間可以共享行為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :messages, concerns: :commentable

resources :articles, concerns: [:commentable, :image_attachable]

</pre>
</div>
<p>上例等價於：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :messages do
  resources :comments
end

resources :articles do
  resources :comments
  resources :images, only: :index
end

</pre>
</div>
<p>Concerns 可以在任何地方使用，譬如在作用域，或是命名空間呼叫裡使用：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
namespace :articles do
  concerns :commentable
end

</pre>
</div>
<h4 id="從物件建立路徑與-url">2.9 從物件建立路徑與 URL</h4><p>除了使用路由輔助方法之外，Rails 也可以從一組參數，建出路徑與 URL。舉例來說，假設有以下路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :magazines do
  resources :ads
end

</pre>
</div>
<p>在使用 <code>magazine_ad_path</code> 時，可以傳入 <code>Magazine</code> 與 <code>Ad</code> 的實體，而不需要傳入 ID：</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= link_to 'Ad details', magazine_ad_path(@magazine, @ad) %&gt;

</pre>
</div>
<p>也可以使用 <code>url_for</code>，搭配一組物件，則 Rails 會自動決定要用那個路由：</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= link_to 'Ad details', url_for([@magazine, @ad]) %&gt;

</pre>
</div>
<p>這個情況裡，Rails 看到 <code>@magazine</code> 與 <code>@ad</code>，會使用 <code>magazine_ad_path</code> 輔助方法。在像是 <code>link_to</code> 的輔助方法，可以直接指定物件，省略 <code>url_for</code>：</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= link_to 'Ad details', [@magazine, @ad] %&gt;

</pre>
</div>
<p>若想要只連到雜誌：</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= link_to 'Magazine details', @magazine %&gt;

</pre>
</div>
<p>要連到不同的動作，在參數陣列的第一個元素，指定動作名稱即可：
<code>erb
&lt;%= link_to 'Edit Ad', [:edit, @magazine, @ad] %&gt;
</code></p><p>這種用法可以將 Model 的實體當做 URL 看待，是使用資源式路由的主要優勢之一。</p><h4 id="新增更多資源式路由">2.10 新增更多資源式路由</h4><p>不受限於七個預設產生的資源式路由。還可以新增更多集合路由、成員路由。</p><h5 id="新增成員路由">2.10.1 新增成員路由</h5><p>要新增成員路由，只需要在 <code>resources</code> 區塊裡加入 <code>member</code> 區塊：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos do
  member do
    get 'preview'
  end
end

</pre>
</div>
<p>這會識別出 <code>/photos/1/preview</code> 的 GET 請求，交給 <code>PhotosController</code> 的 <code>preview</code> 動作處理，相片的 ID 會存在 <code>params[:id]</code>。也會新增 <code>preview_photo_path</code> 與 <code>preview_photo_url</code> 輔助方法。</p><p>在成員路由的區塊裡，可以指定使用特定的 HTTP 動詞。可用的有：<code>get</code>、<code>patch</code>、<code>put</code>、<code>post</code> 或 <code>delete</code>。若成員路由只有一筆，可以使用 <code>:on</code>，便不需要以區塊形式宣告：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos do
  get 'preview', on: :member
end

</pre>
</div>
<p>也可以不使用 <code>:on</code> 選項，會得到相同的成員路由，只是 ID 會存在 <code>params[:photo_id]</code>，而不是 <code>params[:id]</code>。</p><h5 id="新增集合路由">2.10.2 新增集合路由</h5><p>新增一筆集合路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos do
  collection do
    get 'search'
  end
end

</pre>
</div>
<p>這會使 Rails 識別出發送到 <code>/photos/search</code> 的 GET 請求，交給 <code>PhotosController</code> 的 <code>search</code> 動作處理。也會新增 <code>search_photos_path</code> 與 <code>search_photos_url</code> 輔助方法。</p><p>和成員路由相同，可以傳入 <code>:on</code> 選項：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos do
  get 'search', on: :collection
end

</pre>
</div>
<h5 id="給額外的新動作新增路由">2.10.3 給額外的新動作新增路由</h5><p>要新增額外的 <code>new</code> 動作，可以使用 <code>:on</code> 選項：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :comments do
  get 'preview', on: :new
end

</pre>
</div>
<p>這會使 Rails 識別出發送到 <code>/comments/new/preview</code> 的 GET 請求，交給 <code>CommentsController</code> 的 <code>preview</code> 動作處理。也會新增 <code>preview_new_comment_path</code> 與 <code>preview_new_comment_url</code> 輔助方法。</p><div class="info"><p>若發現給資源新增了許多額外的動作，停下來想想是不是要拆成另一個資源。</p></div><h3 id="非資源式路由">3 非資源式路由</h3><p>除了資源式路由之外，將隨意的 URL 對應到動作，Rails 提供了強大的支持。這一節不像資源式路由，會獲得一組自動產生的路由。反而是自己在應用程式裡設定每一條路由。</p><p>雖然通常應該要使用資源式路由，但仍有許多簡單的路由更合適的場景。也不用整個應用程式都得用資源式風格的路由才行，選擇最合適的解決方案。</p><p>簡單的路由使得把傳統的 URL 對應到 Rails 動作變得特別簡單。</p><h4 id="綁定參數">3.1 綁定參數</h4><p>設定一般的路由時，提供一系列的符號給 Rails，Rails 會根據這些符號來對進來的 HTTP 請求做匹配。有兩個特殊符號：<code>:controller</code> 會對應到應用程式裡的 Controller 名稱，而 <code>:action</code> 則是對應到該 Controller 的動作。舉例來說，看下面這條路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get ':controller(/:action(/:id))'

</pre>
</div>
<p>若發送到 <code>/photos/show/1</code> 的請求由這條路由處理（路由檔案裡沒有其它匹配的路由），則會呼叫 <code>PhotosController</code> 的 <code>show</code> 動作，並將 <code>params{:id]</code> 設為 <code>"1"</code>。這條路由也會處理發送到 <code>/photos</code> 的請求，將請求交給 <code>PhotosController#index</code> 處理。因為 <code>:action</code>、<code>:id</code> 放在括號裡代表是可選參數。</p><h4 id="動態片段">3.2 動態片段</h4><p>一般的路由裡可以設定多個動態片段。路由裡任何不是 <code>:controller</code>、<code>:action</code> 的選項，都會變成 <code>params</code> 的一部分。若有以下路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get ':controller/:action/:id/:user_id'

</pre>
</div>
<p>任何至 <code>/photos/show/1/2</code> 的請求會被分配給 <code>PhotosController</code> 的 <code>show</code> 動作處理，<code>params[:id]</code> 則會設為 <code>"1"</code>，而 <code>params[:user_id]</code> 則是 <code>"2"</code>。</p><div class="note"><p>路徑片段有 <code>:controller</code> 時，無法與 <code>:namespace</code>、<code>:module</code> 一起使用。若需要這麼做的話，對 <code>:controller</code> 使用約束條件，明確指定要匹配的命名空間，譬如：</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get ':controller(/:action(/:id))', controller: /admin\/[^\/]+/

</pre>
</div>
<div class="info"><p>動態片段預設不接受 <code>.</code> ── 這是因為 <code>.</code> 是格式化路由的分隔符。如需要在動態片段裡使用 <code>.</code>，用約束條件來處理 ── 例如，<code>id: /[^\/]+/</code> 允許斜線以外的所有字元。</p></div><h4 id="靜態片段">3.3 靜態片段</h4><p>建立路由時，可以指定靜態片段，片段前不加冒號即可：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get ':controller/:action/:id/with_user/:user_id'

</pre>
</div>
<p>這條路由會回應發送到 <code>/photos/show/1/with_user/2</code> 的請求，<code>params</code> 的內容則為 <code>{ controller: 'photos', action: 'show', id: '1', user_id: '2' }</code>。</p><h4 id="查詢字串">3.4 查詢字串</h4><p><code>params</code> 也會存放查詢字串的參數。舉個例子，看看以下這條路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get ':controller/:action/:id'

</pre>
</div>
<p>從 <code>/photos/show/1?user_id=2</code> 進來的請求會分配給 <code>PhotosController</code> 的 <code>show</code> 動作處理，<code>params</code> 的內容為 <code>{ controller: 'photos', action: 'show', id: '1', user_id: '2' }</code>。</p><h4 id="定義預設值">3.5 定義預設值</h4><p>路由裡不需要明確使用 <code>:controller</code> 與 <code>:action</code>。可以指定預設值：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'photos/:id', to: 'photos#show'

</pre>
</div>
<p>有了這條路由之後，Rails 會分配 <code>/photos/12</code> 給 <code>PhotosController</code> 的 <code>show</code> 動作。</p><p>也可以傳 Hash 給 <code>:defaults</code> 選項，來給路由新增預設值。這對於沒有寫動態片段的路由也適用。舉例來說：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'photos/:id', to: 'photos#show', defaults: { format: 'jpg' }

</pre>
</div>
<p>Rails 會匹配 <code>photos/12</code> to the <code>show</code> action of <code>PhotosController</code>, and set <code>params[:format]</code> to <code>"jpg"</code>.</p><h4 id="命名路由">3.6 命名路由</h4><p>可以使用 <code>:as</code> 選項給任何路由取名字：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'exit', to: 'sessions#destroy', as: :logout

</pre>
</div>
<p>會建立出 <code>logout_path</code> 與 <code>logout_url</code> 這兩個具名輔助方法。呼叫 <code>logout_path</code> 會回傳 <code>/exit</code>。</p><p>也可以使用 <code>:as</code> 來覆寫 <code>resources</code> 預設定義的方法：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get ':username', to: 'users#show', as: :user

</pre>
</div>
<p>會定義 <code>user_path</code> 方法，在 Controller、輔助方法、以及 View 裡都可用，會回傳像是 <code>/bob</code> 的路徑。在 <code>UsersController</code> 的 <code>show</code> 動作裡，<code>params[:username]</code> 會有使用者的 <code>username</code>，如不喜歡參數名稱取名為 <code>:username</code> 可以修改這個值。</p><h4 id="http-動詞約束條件">3.7 HTTP 動詞約束條件</h4><p>通常應該使用 <code>get</code>、<code>post</code>、<code>put</code>、<code>patch</code> 以及 <code>delete</code> 方法來限制路由只處理特定的動詞。<code>match</code> 方法與 <code>:via</code> 選項可以一直匹配多個動詞：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
match 'photos', to: 'photos#show', via: [:get, :post]

</pre>
</div>
<p>路由要匹配所有的動詞也可以，<code>via: :all</code>：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
match 'photos', to: 'photos#show', via: :all

</pre>
</div>
<div class="note"><p>將 <code>GET</code> 與 <code>POST</code> 請求路由到單一的動作有安全隱憂。除非有很好的理由，通常應該要避免將所有 HTTP 動詞對應到一個動作上。</p></div><div class="note"><p>Rails 裡執行 <code>GET</code> 不會檢查 CSRF token。永遠不要讓 <code>GET</code> 請求可以執行資料庫寫入動作，更多資訊請參考<a href="security.html#csrf-countermeasures">《安全指南》</a> 關於 〈CSRF countermeasures〉 一節。</p></div><h4 id="片段約束">3.8 片段約束</h4><p>使用 <code>:constraints</code> 選項限制動態片段的格式：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'photos/:id', to: 'photos#show', constraints: { id: /[A-Z]\d{5}/ }

</pre>
</div>
<p>這條路由會匹配像是 <code>/photos/A12345</code>，但不會匹配 <code>/photos/893</code>。可以進一步簡化為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'photos/:id', to: 'photos#show', id: /[A-Z]\d{5}/

</pre>
</div>
<p><code>:constraints</code> 雖然接受正規表示法，但不能使用錨點（anchors）。比如以下路由不會正常工作：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/:id', to: 'articles#show', constraints: {id: /^\d/}

</pre>
</div>
<p>但其實不需要使用錨點，因為所有的路由皆從頭開始匹配。</p><p>舉個例子，下面的路由，若 <code>articles</code> 呼叫 <code>to_param</code> 的值像是 <code>1-hello-world</code>，以數字開頭，就會把請求交給 <code>ArticlesController</code> 的 <code>show</code> 動作處理；而 <code>to_param</code> 的值不以數字開頭，像是 <code>david</code>，則會交給 <code>UsersController</code> 的 <code>show</code> 動作處理。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/:id', to: 'articles#show', constraints: { id: /\d.+/ }
get '/:username', to: 'users#show'

</pre>
</div>
<h4 id="基於請求的約束條件">3.9 基於請求的約束條件</h4><p>也可以使用 <a href="action_controller_overview.html#request-%E7%89%A9%E4%BB%B6"><code>request</code> 物件</a>裡，任何會回傳字串的方法，來宣告路由的約束條件。</p><p>基於 <code>request</code> 物件的約束條件的宣告方式與片段約束條件相同：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'photos', to: 'photos#index', constraints: { subdomain: 'admin' }

</pre>
</div>
<p>約束條件也可以使用區塊形式：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
namespace :admin do
  constraints subdomain: 'admin' do
    resources :photos
  end
end

</pre>
</div>
<h4 id="進階約束條件">3.10 進階約束條件</h4><p>如有更進階的約束條件，可以傳入一個回應 <code>matches?</code> 的物件。假設需要將所有黑名單的使用者交給 <code>BlackListController</code> 處理，可以這麼做：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class BlacklistConstraint
  def initialize
    @ips = Blacklist.retrieve_ips
  end

  def matches?(request)
    @ips.include?(request.remote_ip)
  end
end

Rails.application.routes.draw do
  get '*path', to: 'blacklist#index',
    constraints: BlacklistConstraint.new
end

</pre>
</div>
<p>約束條件也可用 lambda 宣告：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Rails.application.routes.draw do
  get '*path', to: 'blacklist#index',
    constraints: lambda { |request| Blacklist.retrieve_ips.include?(request.remote_ip) }
end

</pre>
</div>
<p><code>matches?</code> 方法與 lambda 都接受 <code>request</code> 物件作為參數。</p><h4 id="路由通配片段">3.11 路由通配片段</h4><p>路由通配是指定匹配參數的方法，比如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'photos/*other', to: 'photos#unknown'

</pre>
</div>
<p>這筆路由會匹配 <code>photos/12</code> 或 <code>/photos/long/path/to/12</code>，並將 <code>params[:other]</code> 設為 <code>"12"</code> 或 <code>"long/path/to/12"</code>。有星號前綴的片段稱之為“通配片段”。</p><p>通配片段可在路由的任何位置出現，譬如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'books/*section/:title', to: 'books#show'

</pre>
</div>
<p>會匹配 <code>books/some/section/last-words-a-memoir</code>，<code>params[:section]</code> 會設為 <code>"some/section"</code>，而 <code>params[:title]</code> 則是 <code>"last-words-a-memoir"</code>。</p><p>技術上來說，路由可有多個通配片段。匹配器會以直觀的方式來將參數賦值給片段，比如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '*a/foo/*b', to: 'test#index'

</pre>
</div>
<p>會匹配 <code>zoo/woo/foo/bar/baz</code>，<code>params[:a]</code> 會設為 <code>'zoo/woo'</code>，而 <code>params[:b]</code> 則是 <code>'bar/baz'</code>。</p><div class="note"><p>發送請求到 <code>"/foo/bar.json"</code> 時，<code>params[:pages]</code> 會設為 <code>"foo/bar"</code>，請求格式為 JSON。若想使用 3.0.x 的行為，可以傳一個 <code>format: false</code>：</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '*pages', to: 'pages#show', format: false

</pre>
</div>
<div class="note"><p>若想要設定格式為必要參數，則可以傳 <code>format: true</code>：</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '*pages', to: 'pages#show', format: true

</pre>
</div>
<h4 id="轉址">3.12 轉址</h4><p>可以使用 <code>redirect</code> 輔助方法將甲路徑轉到乙路徑：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/stories', to: redirect('/articles')

</pre>
</div>
<p>轉址也可以重複使用匹配路由的動態片段：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/stories/:name', to: redirect('/articles/%{name}')

</pre>
</div>
<p><code>redirect</code> 也可以以區塊形式定義，接受 <code>path</code> 參數與 <code>request</code> 物件：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get '/stories/:name', to: redirect { |path_params, req| "/articles/#{path_params[:name].pluralize}" }
get '/stories', to: redirect { |path_params, req| "/articles/#{req.subdomain}" }

</pre>
</div>
<p>Note: 轉址是 301 "Moved Permanently" 轉址。某些瀏覽器或代理伺服器會快取 301 轉址，導致舊的頁面無法存取。</p><p>以上所有的情況裡，若沒有提供主機（<code>http://www.example.com</code>），Rails 會從當下的請求裡取得。</p><h4 id="路由到-rack-應用程式">3.13 路由到 Rack 應用程式</h4><p>除了使用像是 <code>"articles#index"</code> 的字串（會交給 <code>ArticlesController</code> 的 <code>index</code> 動作處理），還可以指定任何 <a href="/rails_on_rack.html">Rack 應用程式</a> 作為端點（Endpoint）：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
match '/application.js', to: Sprockets, via: :all

</pre>
</div>
<p>只要 <code>Sprockets</code> 有回應 <code>call</code>，並回傳 <code>[status, headers, body]</code>，則路由器便不管這是一個 Rack 應用程式，還是單純一個動作。這是個應用 <code>via: :all</code> 的適當場景，因為希望 Rack 應用程式自己處理所有的 HTTP 動詞。</p><div class="note"><p>針對比較好奇的朋友，<code>"articles#index</code> 其實會展開成 <code>ArticlesController.action(:index)</code>，會回傳一個合法的 Rack 應用程式。</p></div><h4 id="使用-root">3.14 使用 <code>root</code>
</h4><p>可以用 <code>root</code> 指定 Rails 要把 <code>"/"</code> 路由到那裡：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
root to: 'pages#main'
root 'pages#main' # 上例的縮寫

</pre>
</div>
<p><code>root</code> 路由應放在 <code>config/routes.rb</code> 的最上方，因為這是最重要的路由，應該第一個匹配。</p><div class="note"><p><code>root</code> 路由只處理對應動作的 <code>GET</code> 請求。</p></div><p><code>root</code> 也可以在命名空間或是作用域裡使用：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
namespace :admin do
  root to: "admin#index"
end

root to: "home#index"

</pre>
</div>
<h4 id="unicode-字元的路由">3.15 Unicode 字元的路由</h4><p>路由中可以直接指定 Unicode 字元：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
get 'こんにちは', to: 'welcome#index'

</pre>
</div>
<h3 id="客製化資源式路由">4 客製化資源式路由</h3><p><code>resources :articles</code> 產生的預設路由與輔助方法通常可以滿足多數需求，但有時可能想在某種程度上進行客製化。Rails 允許資源式輔助方法的通用部分做客製化。</p><h4 id="指定使用的-controller">4.1 指定使用的 Controller</h4><p><code>:controller</code> 選項可明確指定資源要使用的 Controller：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, controller: 'images'

</pre>
</div>
<p>會識別出以 <code>/photos</code> 開頭的請求，交給 <code>Images</code> Controller 處理：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>具名輔助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/photos</td>
<td>images#index</td>
<td>photos_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/new</td>
<td>images#new</td>
<td>new_photo_path</td>
</tr>
<tr>
<td>POST</td>
<td>/photos</td>
<td>images#create</td>
<td>photos_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id</td>
<td>images#show</td>
<td>photo_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id/edit</td>
<td>images#edit</td>
<td>edit_photo_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/photos/:id</td>
<td>images#update</td>
<td>photo_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/photos/:id</td>
<td>images#destroy</td>
<td>photo_path(:id)</td>
</tr>
</tbody>
</table>
<div class="note"><p>產生路徑的輔助方法保持不變 <code>photos_path</code>、<code>new_photo_path</code>。</p></div><p>具有命名空間的 Controller，指定時使用和目錄一樣的表示法即可：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :user_permissions, controller: 'admin/user_permissions'

</pre>
</div>
<p>會把路由交給 <code>Admin::UserPermissions</code> 處理。</p><div class="note"><p>只支援目錄表示法。使用 Ruby 的常數表示法（如：<code>controller: "Admin::UserPermissions"</code>）會導致路由問題，並觸發警告。</p></div><h4 id="指定約束條件">4.2 指定約束條件</h4><p>可用 <code>:constraints</code> 選項來對 <code>id</code> 指定格式，譬如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, constraints: { id: /[A-Z][A-Z][0-9]+/ }

</pre>
</div>
<p>這條宣告限制 <code>:id</code> 參數需符合指定的正規表示法。故這個情況裡，路由器不會匹配 <code>/photos/1</code>，而是會匹配 <code>/photos/RR27</code>。</p><p>可以將約束條件應用至多條路由，使用以下的區塊形式：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
constraints(id: /[A-Z][A-Z][0-9]+/) do
  resources :photos
  resources :accounts
end

</pre>
</div>
<div class="note"><p>當然這裡也可以使用非資源式路由的進階約束條件。</p></div><div class="info"><p><code>:id</code> 預設不接受 <code>.</code> ── 這是因為 <code>.</code> 是格式化路由的分隔符。如需要在 <code>:id</code> 裡使用 <code>.</code>，用約束條件來處理 ── 例如，<code>id: /[^\/]+/</code> 允許斜線以外的所有字元。</p></div><h4 id="覆寫具名輔助方法">4.3 覆寫具名輔助方法</h4><p><code>:as</code> 選項可以覆寫具名輔助方法的名稱。比如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, as: 'images'

</pre>
</div>
<p>will recognize incoming paths beginning with <code>/photos</code> and route the requests to <code>PhotosController</code>, but use the value of the :as option to name the helpers.</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>具名輔助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/photos</td>
<td>photos#index</td>
<td>images_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/new</td>
<td>photos#new</td>
<td>new_image_path</td>
</tr>
<tr>
<td>POST</td>
<td>/photos</td>
<td>photos#create</td>
<td>images_path</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id</td>
<td>photos#show</td>
<td>image_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/photos/:id/edit</td>
<td>photos#edit</td>
<td>edit_image_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/photos/:id</td>
<td>photos#update</td>
<td>image_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/photos/:id</td>
<td>photos#destroy</td>
<td>image_path(:id)</td>
</tr>
</tbody>
</table>
<h4 id="覆寫-new-與-edit-片段">4.4 覆寫 <code>new</code> 與 <code>edit</code> 片段</h4><p><code>:path_names</code> 選項可以覆寫自動在路徑裡產生的 <code>new</code> 與 <code>edit</code> 片段：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, path_names: { new: 'make', edit: 'change' }

</pre>
</div>
<p>路由路徑變更為：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
/photos/make
/photos/1/change

</pre>
</div>
<div class="note"><p>實際的動作名稱並沒有改變。這兩個路徑仍路由到 <code>new</code> and <code>edit</code> 動作。</p></div><div class="info"><p>若發現一直使用 <code>:path_names</code> 的話，考慮使用 <code>scope</code>。</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope path_names: { new: 'make' } do
  # rest of your routes
end

</pre>
</div>
<h4 id="給具名輔助方法加前綴">4.5 給具名輔助方法加前綴</h4><p><code>:as</code> 選項可以給具名輔助方法加上前綴。使用此選項用來避免路由之間的命名衝突，例如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope 'admin' do
  resources :photos, as: 'admin_photos'
end

resources :photos

</pre>
</div>
<p>會產生像是 <code>admin_photos_path</code>、<code>new_admin_photo_path</code> 等路由輔助方法。</p><p>要前綴一組路由輔助方法，使用 <code>scope</code> 與 <code>:as</code> 選項：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope 'admin', as: 'admin' do
  resources :photos, :accounts
end

resources :photos, :accounts

</pre>
</div>
<p>這會產生像是 <code>admin_photos_path</code> 以及 <code>admin_accounts_path</code> 輔助方法，分別對應到 <code>/admin/photos</code> 以及 <code>/admin/accounts</code>。</p><div class="note"><p><code>namespace</code> 作用域會自動新增 <code>:as</code>、<code>:module</code> 以及 <code>:path</code> 前綴。</p></div><p>也可以使用具名參數給路由加上前綴：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope ':username' do
  resources :articles
end

</pre>
</div>
<p>這會產生像是 <code>/bob/articles/1</code> 的路由，並允許在 Controller、View 以及輔助方法使用 <code>params[:username]</code> 來存取路徑傳入的 <code>username</code>。</p><h4 id="限制建立出來的路由">4.6 限制建立出來的路由</h4><p>Rails 預設會為以資源式風格宣告的路由的七個動作（index、show、new、create、edit、update 以及 destroy）建立路由。可用 <code>:only</code> 以及 <code>:except</code> 選項來調整這個行為。<code>:only</code> 選項告訴 Rails 只需要產生那些路由就好：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, only: [:index, :show]

</pre>
</div>
<p><code>/photos</code> 收到 GET 請求會正常工作，但 POST 請求（通常會路由到 <code>:create</code> 動作）則會失敗。</p><p>The <code>:except</code> 選項指定不要建立的路由：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :photos, except: :destroy

</pre>
</div>
<p>這個情況 Rails 會建立出除了 <code>:destory</code> （發送 <code>DELETE</code> 請求到 <code>/photos/:id</code>）之外所有的路由。</p><div class="info"><p>如應用程式有許多 RESTful 風格的路由，使用 <code>:only</code> 與 <code>:except</code> 選項來產生需要的路由。這樣可以減少記憶體的使用量，並加速路由過程。</p></div><h4 id="翻譯路徑">4.7 翻譯路徑</h4><p>使用 <code>scope</code>，可以修改由 <code>resources</code> 產生的路徑名稱：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
scope(path_names: { new: 'neu', edit: 'bearbeiten' }) do
  resources :categories, path: 'kategorien'
end

</pre>
</div>
<p>產生的路由：</p>
<table>
<thead>
<tr>
<th>HTTP 動詞</th>
<th>路徑</th>
<th>Controller#動作</th>
<th>具名輔助方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/kategorien</td>
<td>categories#index</td>
<td>categories_path</td>
</tr>
<tr>
<td>GET</td>
<td>/kategorien/neu</td>
<td>categories#new</td>
<td>new_category_path</td>
</tr>
<tr>
<td>POST</td>
<td>/kategorien</td>
<td>categories#create</td>
<td>categories_path</td>
</tr>
<tr>
<td>GET</td>
<td>/kategorien/:id</td>
<td>categories#show</td>
<td>category_path(:id)</td>
</tr>
<tr>
<td>GET</td>
<td>/kategorien/:id/bearbeiten</td>
<td>categories#edit</td>
<td>edit_category_path(:id)</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/kategorien/:id</td>
<td>categories#update</td>
<td>category_path(:id)</td>
</tr>
<tr>
<td>DELETE</td>
<td>/kategorien/:id</td>
<td>categories#destroy</td>
<td>category_path(:id)</td>
</tr>
</tbody>
</table>
<h4 id="覆寫單數形式">4.8 覆寫單數形式</h4><p>若想定義某個資源的單數形式，給 <code>Inflector</code> 新增額外的規則：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActiveSupport::Inflector.inflections do |inflect|
  inflect.irregular 'tooth', 'teeth'
end

</pre>
</div>
<h4 id="在嵌套資源中使用-as-選項">4.9 在嵌套資源中使用 <code>:as</code> 選項</h4><p><code>:as</code> 選項覆寫在嵌套資源裡，自動產生的路由輔助方法，例如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :magazines do
  resources :ads, as: 'periodical_ads'
end

</pre>
</div>
<p>這會產生出像是：<code>edit_magazine_periodical_ad_path</code> 與 <code>magazine_periodical_ads_url</code> 等輔助方法。</p><h4 id="覆寫具名路由參數">4.10 覆寫具名路由參數</h4><p><code>:param</code> 選項可以覆寫辨識資源的變數，預設是 <code>:id</code>（<a href="#%E5%8B%95%E6%85%8B%E7%89%87%E6%AE%B5">動態片段</a>的名稱）。這個變數是用來產生路由的。可以在 Controller 使用 <code>params[&lt;:param&gt;]</code> 傳入片段變數。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
resources :videos, param: :identifier

</pre>
</div>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
     videos GET  /videos(.:format)                  videos#index
            POST /videos(.:format)                  videos#create
 new_videos GET  /videos/new(.:format)              videos#new
edit_videos GET  /videos/:identifier/edit(.:format) videos#edit

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Video.find_by(identifier: params[:identifier])

</pre>
</div>
<h3 id="檢查與測試路由">5 檢查與測試路由</h3><p>Rails 有提供用來檢查與測試路由的工具。</p><h4 id="列出現有的路由">5.1 列出現有的路由</h4><p>要獲得應用程式完整可用的路由列表，在開發環境下啟動伺服器，瀏覽 <code>http://localhost:3000/rails/info/routes</code>。也可以在終端機裡執行 <code>rake routes</code> 命令。</p><p>以上兩種方法都會列出所有的路由，順序與 <code>config/routes.rb</code> 裡定義的一樣，每條路由的內容會有：</p>
<ul>
<li>路由名稱（有的話）</li>
<li>使用的 HTTP 動詞（若不是回應所有動詞的路由）</li>
<li>匹配的 URL 模式。</li>
<li>路由的參數。</li>
</ul>
<p>舉個例子，以下是某個 RESTful 路由的 <code>rake routes</code> 輸出的一小部分：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
    users GET    /users(.:format)          users#index
          POST   /users(.:format)          users#create
 new_user GET    /users/new(.:format)      users#new
edit_user GET    /users/:id/edit(.:format) users#edit

</pre>
</div>
<p>可以使用環境變數 <code>CONTROLLER</code>，來限制僅列出特定 Controller 的路由：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ CONTROLLER=users rake routes

</pre>
</div>
<div class="info"><p>若將終端機視窗拉寬到無斷行，會發現 <code>rake routes</code> 輸出的可讀性更高。</p></div><h4 id="測試路由">5.2 測試路由</h4><p>路由和其它部分的程式一樣，也需要測試。Rails 提供三個<a href="http://api.rubyonrails.org/classes/ActionDispatch/Assertions/RoutingAssertions.html">內建的斷言方法</a>，專門為簡化路由測試而設計：</p>
<ul>
<li><code>assert_generates</code></li>
<li><code>assert_recognizes</code></li>
<li><code>assert_routing</code></li>
</ul>
<h5 id="assert-generates-斷言">5.2.1 <code>assert_generates</code> 斷言</h5><p><code>assert_generates</code> 檢測給定選項產生出來的預設路由或自訂路由是否正確：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
assert_generates '/photos/1', { controller: 'photos', action: 'show', id: '1' }
assert_generates '/about', controller: 'pages', action: 'about'

</pre>
</div>
<h5 id="assert-recognizes-斷言">5.2.2 <code>assert_recognizes</code> 斷言</h5><p><code>assert_recognizes</code> 與 <code>assert_generates</code> 相反。檢測給定的路徑是否能識別出來，並路由到正確的位置。比如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
assert_recognizes({ controller: 'photos', action: 'show', id: '1' }, '/photos/1')

</pre>
</div>
<p>可用 <code>:method</code> 參數來指定 HTTP 動詞：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
assert_recognizes({ controller: 'photos', action: 'create' }, { path: 'photos', method: :post })

</pre>
</div>
<h5 id="assert-routing-斷言">5.2.3 <code>assert_routing</code> 斷言</h5><p><code>assert_routing</code> 斷言雙向檢查路由：測試路徑產生的選項對不對，以及選項產生出來的路徑是否正確。因此，結合了 <code>assert_generates</code> 與 <code>assert_recognizes</code> 的功能：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
assert_routing({ path: 'photos', method: :post }, { controller: 'photos', action: 'create' })

</pre>
</div>


        <h3>反饋</h3>
        <p>
          歡迎幫忙改善指南的品質。
        </p>
        <p>
          如發現任何錯誤之處，歡迎修正。開始貢獻前，可以先閱讀<a href="http://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">貢獻指南：文件</a>。
        </p>
        <p>翻譯如有錯誤，深感抱歉，歡迎 <a href="https://github.com/docrails-tw/guides/fork">Fork</a> 修正，或至此處<a href="https://github.com/docsrails-tw/guides/issues/new">回報</a>。</p>
        <p>
          文章可能有未完成或過時的內容。請先檢查 <a href="http://edgeguides.rubyonrails.org">Edge Guides</a> 來確定問題在 master 是否已經修掉了。再上 master 補上缺少的文件。內容參考 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南準則</a>來了解行文風格。
        </p>
        <p>最後，任何關於 Ruby on Rails 文件的討論，歡迎至 <a href="http://groups.google.com/group/rubyonrails-docs">rubyonrails-docs 郵件論壇</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide">
  <div id="footer">
    <div class="wrapper">
      <ol class="snsb" style="margin-left: 13px">
  <li><iframe src="http://ghbtns.com/github-btn.html?user=docrails-tw&repo=rails.ruby.tw&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80" height="20"></iframe></li>
  <li><div class="fb-like" data-href="http://rails.ruby.tw/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div></li>
  <li><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://rails.ruby.tw/" data-text="Ruby on Rails 指南：系統化學習 Rails（Rails 4.2 版本）" data-lang="zh-TW" data-hashtags="railsguidestw">ツイート</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
</ol>

      <p>本著作係採用<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh_TW">創用 CC 姓名標示-相同方式分享 4.0 國際授權條款</a>授權。</p>
<p>“Rails”、“Ruby on Rails”，以及 Rails logo 為 David Heinemeier Hansson 的商標。版權所有。</p>

    </div>
  </div>

  <script src="javascripts/jquery.min.js"></script>
  <script src="javascripts/responsive-tables.js"></script>
  <script src="javascripts/guides.js"></script>
  <script src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,"script","//www.google-analytics.com/analytics.js","ga");

    ga("create", "UA-49903900-1", "auto");
    ga("require", "displayfeatures");
    ga("send", "pageview");
  </script>
</body>
</html>
