<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>客製與新增 Rails 產生器與模版 — Ruby on Rails 指南</title>

  <link href="stylesheets/style.css" rel="stylesheet">
  <link href="stylesheets/print.css" rel="stylesheet" media="print">
  <link href="stylesheets/syntaxhighlighter/shCore.css" rel="stylesheet">
  <link href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" rel="stylesheet">
  <link href="stylesheets/fixes.css" rel="stylesheet">
  <link href="http://fonts.googleapis.com/css?family=Noto+Sans:400,700" rel="stylesheet">
  <link href="http://fonts.googleapis.com/css?family=Noto+Serif:700" rel="stylesheet">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon">
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多內容 <a href="http://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多內容
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://rubyonrails.org/">綜覽</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/download">下載</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/deploy">部署</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">原始碼</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/screencasts">影片</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/documentation">文件</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/community">社群</a></li>
        <li class="more-info"><a href="http://weblog.rubyonrails.org/">Blog</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">指南目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr>
              <dl class="L">
                <dt>起步走</dt>
                <dd><a href="getting_started.html">Rails 起步走</a></dd>
                <dt>Models</dt>
                <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record 遷移</a></dd>
                <dd><a href="active_record_validations.html">Active Record 驗證</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record 回呼</a></dd>
                <dd><a href="association_basics.html">Active Record 關聯</a></dd>
                <dd><a href="active_record_querying.html">Active Record 查詢</a></dd>
                <dt>Views</dt>
                <dd><a href="layouts_and_rendering.html">Rails 算繪與版型</a></dd>
                <dd><a href="form_helpers.html">Action View 表單輔助方法</a></dd>
                <dt>Controllers</dt>
                <dd><a href="action_controller_overview.html">Action Controller 綜覽</a></dd>
                <dd><a href="routing.html">Rails 路由：深入淺出</a></dd>
              </dl>
              <dl class="R">
                <dt>深入了解</dt>
                <dd><a href="active_support_core_extensions.html">Active Support 核心擴展</a></dd>
                <dd><a href="i18n.html">Rails 國際化 API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer 基礎</a></dd>
                <dd><a href="security.html">Rails 安全指南</a></dd>
                <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                <dd><a href="configuring.html">Rails 應用程式設定</a></dd>
                <dd><a href="command_line.html">Rake 任務與 Rails 命令列工具</a></dd>
                <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">在 Rails 使用 JavaScript</a></dd>
                <dt>擴充 Rails</dt>
                <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                <dd><a href="generators.html">客製與新建 Rails 產生器</a></dd>
                <dd><a href="rails_application_templates.html">Rails 應用程式模版</a></dd>
                <dt>貢獻 Ruby on Rails</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">貢獻 Ruby on Rails</a></dd>
                <dd><a href="api_documentation_guidelines.html">API 文件準則</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南準則</a></dd>
                <dt>維護方針</dt>
                <dd><a href="maintenance_policy.html">維護方針</a></dd>
                <dt>發佈記</dt>
                <dd><a href="upgrading_ruby_on_rails.html">升級 Ruby on Rails</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 發佈記</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 發佈記</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 發佈記</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 發佈記</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 發佈記</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 發佈記</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 發佈記</a></dd>
                <dt>Rails 指南翻譯術語</dt>
                <dd><a href="translation_terms.html">翻譯術語</a></dd>
              </dl>
          </div>
        </li>
        <!-- <li><a class="nav-item" href="//github.com/docrails-tw/wiki">參與翻譯</a></li> -->
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li><a class="nav-item" href="credits.html">致謝</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南目錄</option>
              <optgroup label="起步走">
                  <option value="getting_started.html">Rails 起步走</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移</option>
                  <option value="active_record_validations.html">Active Record 驗證</option>
                  <option value="active_record_callbacks.html">Active Record 回呼</option>
                  <option value="association_basics.html">Active Record 關聯</option>
                  <option value="active_record_querying.html">Active Record 查詢</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 算繪與版型</option>
                  <option value="form_helpers.html">Action View 表單輔助方法</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 綜覽</option>
                  <option value="routing.html">Rails 路由：深入淺出</option>
              </optgroup>
              <optgroup label="深入了解">
                  <option value="active_support_core_extensions.html">Active Support 核心擴展</option>
                  <option value="i18n.html">Rails 國際化 API</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎</option>
                  <option value="security.html">Rails 安全指南</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">Rails 應用程式設定</option>
                  <option value="command_line.html">Rake 任務與 Rails 命令列工具</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">在 Rails 使用 JavaScript</option>
              </optgroup>
              <optgroup label="擴充 Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">客製與新建 Rails 產生器</option>
                  <option value="rails_application_templates.html">Rails 應用程式模版</option>
              </optgroup>
              <optgroup label="貢獻 Ruby on Rails">
                  <option value="contributing_to_ruby_on_rails.html">貢獻 Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API 文件準則</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南準則</option>
              </optgroup>
              <optgroup label="維護方針">
                  <option value="maintenance_policy.html">維護方針</option>
              </optgroup>
              <optgroup label="發佈記">
                  <option value="upgrading_ruby_on_rails.html">升級 Ruby on Rails</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 發佈記</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 發佈記</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 發佈記</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 發佈記</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 發佈記</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 發佈記</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 發佈記</option>
              </optgroup>
              <optgroup label="Rails 指南翻譯術語">
                  <option value="translation_terms.html">翻譯術語</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide">

  <div id="feature">
    <div class="wrapper">
      <h2>客製與新增 Rails 產生器與模版</h2><p>如有計劃要改善工作流程，Rails 產生器（Generator）是基本工具。本篇教如何建立產生器以及如何客製化 Rails 內建的產生器。</p><p>讀完本篇，您將了解：</p>
<ul>
<li>如何看應用程式裡有那些產生器可用。</li>
<li>如何用模版建立產生器。</li>
<li>Rails 如何找到產生器並呼叫它們。</li>
<li>如何用新的產生器來客製化鷹架。</li>
<li>如何變更產生器模版來客製化鷹架。</li>
<li>如何用替代方案避免覆寫一大組產生器。</li>
<li>如何新建應用程式模版。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#%E5%88%9D%E6%AC%A1%E6%8E%A5%E8%A7%B8">初次接觸</a></li>
<li><a href="#%E5%BB%BA%E7%AB%8B%E7%AC%AC%E4%B8%80%E5%80%8B%E7%94%A2%E7%94%9F%E5%99%A8">建立第一個產生器</a></li>
<li><a href="#%E7%94%A8%E7%8F%BE%E6%9C%89%E7%94%A2%E7%94%9F%E5%99%A8%E5%BB%BA%E7%AB%8B%E6%96%B0%E7%94%A2%E7%94%9F%E5%99%A8">用現有產生器建立新產生器</a></li>
<li><a href="#%E7%94%A2%E7%94%9F%E5%99%A8%E7%9A%84%E6%9F%A5%E6%89%BE%E9%A0%86%E5%BA%8F">產生器的查找順序</a></li>
<li><a href="#%E5%AE%A2%E8%A3%BD%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">客製化工作流程</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E7%94%A2%E7%94%9F%E5%99%A8%E6%A8%A1%E7%89%88%E4%BE%86%E5%AE%A2%E8%A3%BD%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">修改產生器模版來客製化工作流程</a></li>
<li><a href="#%E6%96%B0%E5%A2%9E%E7%94%A2%E7%94%9F%E5%99%A8%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88">新增產生器的替代方案</a></li>
<li><a href="#%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E6%A8%A1%E7%89%88">應用程式模版</a></li>
<li>
<a href="#%E7%94%A2%E7%94%9F%E5%99%A8%E6%96%B9%E6%B3%95%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A">產生器方法參考手冊</a>

<ul>
<li><a href="#gem"><code>gem</code></a></li>
<li><a href="#gem_group"><code>gem_group</code></a></li>
<li><a href="#add_source"><code>add_source</code></a></li>
<li><a href="#inject_into_file"><code>inject_into_file</code></a></li>
<li><a href="#gsub_file"><code>gsub_file</code></a></li>
<li><a href="#application"><code>application</code></a></li>
<li><a href="#git"><code>git</code></a></li>
<li><a href="#vendor"><code>vendor</code></a></li>
<li><a href="#lib"><code>lib</code></a></li>
<li><a href="#rakefile"><code>rakefile</code></a></li>
<li><a href="#initializer"><code>initializer</code></a></li>
<li><a href="#generate"><code>generate</code></a></li>
<li><a href="#rake"><code>rake</code></a></li>
<li><a href="#capify-bang"><code>capify!</code></a></li>
<li><a href="#route"><code>route</code></a></li>
<li><a href="#readme"><code>readme</code></a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="初次接觸">1 初次接觸</h3><p>使用 <code>rails</code> 指令時，其實就使用了 Rails 產生器。要查看 Rails 完整的產生器清單，輸入 <code>rails generate</code>：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails new myapp
$ cd myapp
$ bin/rails generate

</pre>
</div>
<p>需要特定產生器的詳細說明，可以傳入 <code>--help</code>，比如要瀏覽輔助方法產生器的說明：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate helper --help

</pre>
</div>
<h3 id="建立第一個產生器">2 建立第一個產生器</h3><p>自 Rails 3.0 起，產生器用 <a href="https://github.com/erikhuda/thor">Thor</a>
重寫了。Thor 負責解析命令列參數、具有強大的檔案處理 API。輕輕鬆鬆便能打造一個 Generator，如何寫個能在 <code>config/initializers</code> 目錄下產生 <code>initializer</code> 檔案（<code>initializer.rb</code>）的 Generator 呢？</p><p>首先新建 <code>lib/generators/initializer_generator.rb</code> 檔案，填入如下內容：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class InitializerGenerator &lt; Rails::Generators::Base
  def create_initializer_file
    create_file "config/initializers/initializer.rb", "# Add initialization content here"
  end
end

</pre>
</div>
<div class="note"><p><code>create_file</code> 是 <code>Thor::Actions</code> 提供的方法。<code>create_file</code> 及其它 Thor 提供的方法請查閱 <a href="http://rdoc.info/github/wycats/thor/master/Thor/Actions.html">Thor 的 API 文件</a>。</p></div><p>新的產生器非常簡單：從 <code>Rails::Generators::Base</code> 繼承而來，內有一個方法。呼叫產生器時，所有產生器的公有方法會依定義的順序執行。最後，呼叫 <code>create_file</code> 方法會在指定的路徑產生出檔案，檔案裡有給定的內容。如熟悉 Rails 應用程式模版的 API，便會感到這兩個 API 其實大同小異。</p><p>要呼叫新的產生器，只需要：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate initializer

</pre>
</div>
<p>在繼續解說之前，看看剛剛建立出來的產生器的說明文件：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate initializer --help

</pre>
</div>
<p>如果產生器放在適當的命名空間，譬如 <code>ActiveRecord::Generators::ModelGenerator</code>，Rails 通常可以產生出不錯的指令說明。但這個情況不適用。這個問題有兩個解決辦法，一是使用 <code>desc</code> 自己寫說明：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class InitializerGenerator &lt; Rails::Generators::Base
  desc "This generator creates an initializer file at config/initializers"
  def create_initializer_file
    create_file "config/initializers/initializer.rb", "# Add initialization content here"
  end
end

</pre>
</div>
<p>現在可以使用 <code>--help</code> 看到新的說明。第二種新增說明的方法是，在產生器所在的目錄裡面，建立一個叫做 <code>USAGE</code> 的檔案。</p><h3 id="用現有產生器建立新產生器">3 用現有產生器建立新產生器</h3><p>產生器本身也可以用產生器來產生：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate generator initializer
      create  lib/generators/initializer
      create  lib/generators/initializer/initializer_generator.rb
      create  lib/generators/initializer/USAGE
      create  lib/generators/initializer/templates

</pre>
</div>
<p>這是剛建立的產生器：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class InitializerGenerator &lt; Rails::Generators::NamedBase
  source_root File.expand_path("../templates", __FILE__)
end

</pre>
</div>
<p>首先，注意到是繼承自 <code>Rails::Generators::NamedBase</code>，而不是 <code>Rails::Generators::Base</code>。這表示產生器至少接受一個參數，也就是 <code>initializer</code> 的名稱，會存在程式碼的 <code>name</code> 變數裡。</p><p>可以透過呼叫新的產生器的說明看看（記得先刪除舊的產生器檔案）：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate initializer --help
Usage:
  rails generate initializer NAME [options]

</pre>
</div>
<p>新的產生器有一個類別方法：<code>source_root</code>。這個方法指向產生器模版的位置，預設是指向 <code>lib/generators/initializer/templates</code>。</p><p>為了要了解產生器模版是做什麼的，先建立 <code>lib/generators/initializer/templates/initializer.rb</code>，並填入以下內容：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Add initialization content here

</pre>
</div>
<p>接著修改產生器，使產生器呼叫時，複製這個模版：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class InitializerGenerator &lt; Rails::Generators::NamedBase
  source_root File.expand_path("../templates", __FILE__)

  def copy_initializer_file
    copy_file "initializer.rb", "config/initializers/#{file_name}.rb"
  end
end

</pre>
</div>
<p>接著執行：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate initializer core_extensions

</pre>
</div>
<p>現在可以看到一個 <code>initializer</code>，叫做 <code>core_extensions</code> 被建立出來了，位置是：<code>config/initializers/core_extensions.rb</code>，內容是模版所填之內容。<code>copy_file</code> 在 <code>source_root</code> 複製檔案到指定的目標路徑。當繼承自 <code>Rails::Generators::NamedBase</code> 時，會自動建立 <code>file_name</code> 這個方法。</p><p>產生器可用的方法在<a href="#%E7%94%A2%E7%94%9F%E5%99%A8%E6%96%B9%E6%B3%95%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A">最後一節</a>說明。</p><h3 id="產生器的查找順序">4 產生器的查找順序</h3><p>執行 <code>rails generate initializer core_extensions</code> 時，Rails 依序 <code>require</code> 這些檔案直到找到為止：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
rails/generators/initializer/initializer_generator.rb
generators/initializer/initializer_generator.rb
rails/generators/initializer_generator.rb
generators/initializer_generator.rb

</pre>
</div>
<p>若都沒有找到則會回錯誤訊息。</p><div class="info"><p>上例將檔案放在應用程式的 <code>lib</code> 目錄下，因為該目錄屬於 <code>$LOAD_PATH</code>。</p></div><h3 id="客製化工作流程">5 客製化工作流程</h3><p>Rails 內建的產生器已經足夠靈活，可以用來客製化鷹架。可以在 <code>config/application.rb</code> 裡設定，以下是某些設定的預設值：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.generators do |g|
  g.orm             :active_record
  g.template_engine :erb
  g.test_framework  :test_unit, fixture: true
end

</pre>
</div>
<p>在客製化工作流程之前，先看看預設的鷹架輸出是什麼：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate scaffold User name:string
      invoke  active_record
      create    db/migrate/20140513182748_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/models/user_test.rb
      create      test/fixtures/users.yml
      invoke  resource_route
       route    resources :users
      invoke  scaffold_controller
      create    app/controllers/users_controller.rb
      invoke    erb
      create      app/views/users
      create      app/views/users/index.html.erb
      create      app/views/users/edit.html.erb
      create      app/views/users/show.html.erb
      create      app/views/users/new.html.erb
      create      app/views/users/_form.html.erb
      invoke    test_unit
      create      test/controllers/users_controller_test.rb
      invoke    helper
      create      app/helpers/users_helper.rb
      invoke      test_unit
      create        test/helpers/users_helper_test.rb
      invoke    jbuilder
      create      app/views/users/index.json.jbuilder
      create      app/views/users/show.json.jbuilder
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/users.js.coffee
      invoke    scss
      create      app/assets/stylesheets/users.css.scss
      invoke  scss
      create    app/assets/stylesheets/scaffolds.css.scss

</pre>
</div>
<p>看輸出便很容易可以了解，Rails 的產生器是如何工作的。鷹架產生器實際上沒有產生任何東西，只是去呼叫其它的產生器。我們便可以新增、更換、移除任何產生器的呼叫。譬如，鷹架產生器呼叫 <code>scaffold_controller</code>，<code>scaffold_controller</code> 在呼叫 <code>erb</code>、<code>test_unit</code>、<code>helper</code> 以及 <code>jbuilder</code>。每個產生器各司其職，很輕鬆便可以重複使用，減少重複的程式碼。</p><p>對工作流程的第一個客製化，便是讓鷹架停止產生 CSS、JavaScript 以及測試用的假資料。可以透過修改設定檔：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.generators do |g|
  g.orm             :active_record
  g.template_engine :erb
  g.test_framework  :test_unit, fixture: false
  g.stylesheets     false
  g.javascripts     false
end

</pre>
</div>
<p>若使用產生器再產生一次，可以看到沒有建立出 CSS、JavaScripts 以及假資料。若想進一步客製化，譬如使用 DataMapper 與 RSpec 來取代 Active Record 與 TestUnit，只需要將 Gem 加到 Gemfile，並設定產生器即可。</p><p>接著來客製化輔助方法產生器，先建立新的輔助方法產生器，這個產生器會幫輔助方法裡的實體變數自動加上 <code>attr_reader</code>。首先在 Rails 的命名空間下建立產生器，這樣 Rails 才能找到。</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate generator rails/my_helper
      create  lib/generators/rails/my_helper
      create  lib/generators/rails/my_helper/my_helper_generator.rb
      create  lib/generators/rails/my_helper/USAGE
      create  lib/generators/rails/my_helper/templates

</pre>
</div>
<p>接著刪掉不會使用到的 <code>templates</code> 資料夾，以及產生器的 <code>source_root</code> 這行。加入以下方法之後，產生器看起來會像是：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# lib/generators/rails/my_helper/my_helper_generator.rb
class Rails::MyHelperGenerator &lt; Rails::Generators::NamedBase
  def create_helper_file
    create_file "app/helpers/#{file_name}_helper.rb", &lt;&lt;-FILE
module #{class_name}Helper
  attr_reader :#{plural_name}, :#{plural_name.singularize}
end
    FILE
  end
end

</pre>
</div>
<p>可以建立輔助方法，來試試看新的產生器：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate my_helper products
      create  app/helpers/products_helper.rb

</pre>
</div>
<p>會在 <code>app/helpers</code> 產生出這個輔助方法：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ProductsHelper
  attr_reader :products, :product
end

</pre>
</div>
<p>與預期相符，現在可以讓鷹架使用新的輔助方法產生器了。編輯 <code>config/application.rb</code>：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.generators do |g|
  g.orm             :active_record
  g.template_engine :erb
  g.test_framework  :test_unit, fixture: false
  g.stylesheets     false
  g.javascripts     false
  g.helper          :my_helper
end

</pre>
</div>
<p>再產生看看是否用了新加的輔助方法產生器：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate scaffold Post body:text
      [...]
      invoke    my_helper
      create      app/helpers/posts_helper.rb

</pre>
</div>
<p>可以看到這裡用了新寫的輔助方法產生器，而不是 Rails 內建的。但還少了一樣東西，產生測試的產生器。使用舊的產生器來修改。</p><p>從 Rails 3.0 開始，因為引入了 <code>hook</code>，修改測試產生器變得非常簡單。不用綁在一個測試框架上，可以透過 hook，測試框架只需要實作 hook，就可以與 Rails 相容。</p><p>將產生器修改為：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# lib/generators/rails/my_helper/my_helper_generator.rb
class Rails::MyHelperGenerator &lt; Rails::Generators::NamedBase
  def create_helper_file
    create_file "app/helpers/#{file_name}_helper.rb", &lt;&lt;-FILE
module #{class_name}Helper
  attr_reader :#{plural_name}, :#{plural_name.singularize}
end
    FILE
  end

  hook_for :test_framework
end

</pre>
</div>
<p>現在當輔助方法產生器被呼叫時，TestUnit 會被設定成測試框架，會試著執行 <code>Rails::TestUnitGenerator</code> 與 <code>TestUnit::MyHelperGenerator</code>。由於這兩者都沒有定義，可以跟產生器說，使用 Rails 內建的 <code>TestUnit::Generators::HelperGenerator</code> 來取代。將剛剛的 <code>hook_for</code> 新增一個 <code>:as</code> 選項即可：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Search for :helper instead of :my_helper
hook_for :test_framework, as: :helper

</pre>
</div>
<p>現在重新執行鷹架，現在也會產生測試了！</p><h3 id="修改產生器模版來客製化工作流程">6 修改產生器模版來客製化工作流程</h3><p>上例我們不過想讓輔助方法產生出的輔助方法多一行程式碼，沒加別的功能。其實還有更簡單的方法可以辦到，換掉 Rails 內建的輔助方法產生器（<code>Rails::Generators::HelperGenerator</code>）原生的模版。</p><p>Rails 3.0 之後，產生器不僅會在模版的 <code>source_root</code> 路徑下尋找，也會在其它路徑下，找看看有沒有模版存在，譬如：<code>lib/templates</code>。由於想客製的是 <code>Rails::Generators::HelperGenerator</code>，可以透過在 <code>lib/templates/rails/helper</code> 目錄下建立 <code>helper.rb</code>，填入以下內容：</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
module &lt;%= class_name %&gt;Helper
  attr_reader :&lt;%= plural_name %&gt;, :&lt;%= plural_name.singularize %&gt;
end

</pre>
</div>
<p>將 <code>config/application.rb</code> 上次的修改還原（刪除下面這段）：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.generators do |g|
  g.orm             :active_record
  g.template_engine :erb
  g.test_framework  :test_unit, fixture: false
  g.stylesheets     false
  g.javascripts     false
end

</pre>
</div>
<p>產生新的資源看看，可以看到相同的結果！若想要客製化鷹架模版，譬如想要客製化鷹架建立出來的 <code>index.html.erb</code> 與 <code>edit.html.erb</code>，在 <code>lib/templates/erb/scaffold/</code>，新建 <code>index.html.erb</code> 與 <code>edit.html.erb</code>，填入想產生的內容即可。</p><h3 id="新增產生器的替代方案">7 新增產生器的替代方案</h3><p>產生器最後要加入的功能是替代方案。舉個例子，假設想在 <code>TestUnit</code> 加入像是 <a href="https://github.com/thoughtbot/shoulda">shoulda</a> 的功能。由於 TestUnit 已實作所有 Rails 產生器所需要的方法，而 Shoulda 不過是覆寫某部分功能，不需要為了 Shoulda 重新實作這些產生器，可以告訴 Rails 在 <code>Shoulda</code> 命名空間下沒找到產生器時，可以用 <code>TestUnit</code> 來代替。</p><p>看看怎麼實作，首先打開 <code>config/application.rb</code>，修改如下：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.generators do |g|
  g.orm             :active_record
  g.template_engine :erb
  g.test_framework  :shoulda, fixture: false
  g.stylesheets     false
  g.javascripts     false

  # Add a fallback!
  g.fallbacks[:shoulda] = :test_unit
end

</pre>
</div>
<p>現在用鷹架新建 <code>Comment</code>資源，會看到輸出裡呼叫了 <code>shoulda</code> 產生器，最下方替代方案使用了 TestUnit 產生器：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails generate scaffold Comment body:text
      invoke  active_record
      create    db/migrate/20130924143118_create_comments.rb
      create    app/models/comment.rb
      invoke    shoulda
      create      test/models/comment_test.rb
      create      test/fixtures/comments.yml
      invoke  resource_route
       route    resources :comments
      invoke  scaffold_controller
      create    app/controllers/comments_controller.rb
      invoke    erb
      create      app/views/comments
      create      app/views/comments/index.html.erb
      create      app/views/comments/edit.html.erb
      create      app/views/comments/show.html.erb
      create      app/views/comments/new.html.erb
      create      app/views/comments/_form.html.erb
      invoke    shoulda
      create      test/controllers/comments_controller_test.rb
      invoke    my_helper
      create      app/helpers/comments_helper.rb
      invoke      shoulda
      create        test/helpers/comments_helper_test.rb
      invoke    jbuilder
      create      app/views/comments/index.json.jbuilder
      create      app/views/comments/show.json.jbuilder
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/comments.js.coffee
      invoke    scss

</pre>
</div>
<p>替代方案讓每個產生器各司其職、提高程式碼重用性、減少重複的程式碼。</p><h3 id="應用程式模版">8 應用程式模版</h3><p>已經見過如何在應用程式裡使用產生器，這些方法也可以用來產生應用程式。這種產生器叫做“模版”。以下是模版 API 的綜覽。更詳細的文件請參考 <a href="rails_application_templates.html">Rails 應用程式模版指南</a>。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
gem "rspec-rails",    group: "test"
gem "cucumber-rails", group: "test"

if yes?("Would you like to install Devise?")
  gem "devise"
  generate "devise:install"
  model_name = ask("What would you like the user model to be called? [user]")
  model_name = "user" if model_name.blank?
  generate "devise", model_name
end

</pre>
</div>
<p>上例中我們為產生的 Rails 應用程式新增了兩個 gem（<code>rspec-rails</code>、<code>cucumber-rails</code>），放在 <code>test</code> 群組，會自動加到 <code>Gemfile</code>。接著問使用者是否要安裝 Devise？若使用者回答 <code>y</code> 或 <code>yes</code>，則會把 <code>gem "devise"</code> 加到 <code>Gemfile</code>，並執行 <code>devise:install</code> 產生器，並詢問預設的使用者 Model 名稱為？並產生出該 Model。</p><p>現在將上面的程式碼，存成 <code>template.rb</code>，便可在 <code>rails new</code> 輸入 <code>-m</code> 選項來使用這個 Template：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails new thud -m template.rb

</pre>
</div>
<p>這個命令會使用 <code>template.rb</code> 來產生 <code>Thud</code> 應用程式。</p><p>模版不需要存在本機，<code>-m</code> 選項也支援線上模版：</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails new thud -m https://gist.github.com/radar/722911/raw/

</pre>
</div>
<p>本文最後一節不會介紹如何產生最厲害的模版，而是會走一遍可用的方法有那些，了解之後便可以自己寫出模版。這些方法適用於產生器。</p><h3 id="產生器方法參考手冊">9 產生器方法參考手冊</h3><p>以下是 Rails 產生器與模版內可用的方法（<a href="https://github.com/rails/rails/blob/master/railties/lib/rails/generators/actions.rb">原始碼</a>）</p><div class="note"><p>本文沒有介紹 Thor 所提供的方法，關於 Thor 提供的方法請查閱 <a href="http://rdoc.info/github/wycats/thor/master/Thor/Actions.html">Thor 的 API 文件</a>。</p></div><h4 id="gem">9.1 <code>gem</code>
</h4><p>指定應用程式依賴的 Gem。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
gem "rspec", group: "test", version: "2.1.0"
gem "devise", "1.1.5"

</pre>
</div>
<p>可用選項有：</p>
<ul>
<li>
<code>:group</code> - The group in the <code>Gemfile</code> where this gem should go.</li>
<li>
<code>:version</code> - The version string of the gem you want to use. Can also be specified as the second argument to the method.</li>
<li>
<code>:git</code> - The URL to the git repository for this gem.</li>
</ul>
<p>此方法任何其它可能傳入的選項，請放在行尾：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
gem "devise", git: "git://github.com/plataformatec/devise", branch: "master"

</pre>
</div>
<p>以上程式碼會將下行寫入 <code>Gemfile</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
gem "devise", git: "git://github.com/plataformatec/devise", branch: "master"

</pre>
</div>
<h4 id="gem_group">9.2 <code>gem_group</code>
</h4><p>把 Gem 放入群組裡：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
gem_group :development, :test do
  gem "rspec-rails"
end

</pre>
</div>
<h4 id="add_source">9.3 <code>add_source</code>
</h4><p>指定 <code>Gemfile</code> 使用的來源：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
add_source "http://gems.github.com"

</pre>
</div>
<h4 id="inject_into_file">9.4 <code>inject_into_file</code>
</h4><p>注入一塊程式碼到檔案指定位置：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
inject_into_file 'name_of_file.rb', after: "#The code goes below this line. Don't forget the Line break at the end\n" do &lt;&lt;-'RUBY'
  puts "Hello World"
RUBY
end

</pre>
</div>
<h4 id="gsub_file">9.5 <code>gsub_file</code>
</h4><p>替換檔案裡的文字。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
gsub_file 'name_of_file.rb', 'method.to_be_replaced', 'method.the_replacing_code'

</pre>
</div>
<p>用正規表達式更簡潔。亦可用 <code>append_file</code> 及 <code>prepend_file</code> 來附加、插入程式碼到檔案裡。</p><h4 id="application">9.6 <code>application</code>
</h4><p>在 <code>config/application.rb</code> 應用程式類別定義後面，新增一行程式碼。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
application "config.asset_host = 'http://example.com'"

</pre>
</div>
<p>方法也可改寫成區塊形式：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
application do
  "config.asset_host = 'http://example.com'"
end

</pre>
</div>
<p>可用選項有：</p>
<ul>
<li>
<code>:env</code> - 指定這個設定應用的環境。若要使用此選項，推薦使用區塊語法：</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
application(nil, env: "development") do
  "config.asset_host = 'http://localhost:3000'"
end

</pre>
</div>
<h4 id="git">9.7 <code>git</code>
</h4><p>執行特定的 <code>git</code> 命令：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
git :init
git add: "."
git commit: "-m First commit!"
git add: "onefile.rb", rm: "badfile.cxx"

</pre>
</div>
<p>Hash 的值便是傳給 <code>git</code> 命令的值。一次可使用多條 git 命令，<strong>但不保證執行的順序與指定的順序相同</strong>。</p><h4 id="vendor">9.8 <code>vendor</code>
</h4><p>將含有特定程式碼的檔案，放入 <code>vendor</code> 目錄。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
vendor "sekrit.rb", '#top secret stuff'

</pre>
</div>
<p>此方法接受區塊參數：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
vendor "seeds.rb" do
  "puts 'in your app, seeding your database'"
end

</pre>
</div>
<h4 id="lib">9.9 <code>lib</code>
</h4><p>將含有特定程式碼的檔案，放入 <code>lib</code> 目錄。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
lib "special.rb", "p Rails.root"

</pre>
</div>
<p>此方法接受區塊參數：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
lib "super_special.rb" do
  puts "Super special!"
end

</pre>
</div>
<h4 id="rakefile">9.10 <code>rakefile</code>
</h4><p>在應用程式的 <code>lib/tasks</code> 新建一個 Rake 檔案：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
rakefile "test.rake", "hello there"

</pre>
</div>
<p>此方法接受區塊參數</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
rakefile "test.rake" do
  %Q{
    task rock: :environment do
      puts "Rockin'"
    end
  }
end

</pre>
</div>
<h4 id="initializer">9.11 <code>initializer</code>
</h4><p>在應用程式的 <code>config/initializers</code> 新建一個 <code>initializer</code>：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
initializer "begin.rb", "puts 'this is the beginning'"

</pre>
</div>
<p>此方法也接受區塊，並預期回傳字串：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
initializer "begin.rb" do
  "puts 'this is the beginning'"
end

</pre>
</div>
<h4 id="generate">9.12 <code>generate</code>
</h4><p>執行特定的產生器，第一個參數為產生器的名字，其餘參數直接傳給產生器。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
generate "scaffold", "forums title:string description:text"

</pre>
</div>
<h4 id="rake">9.13 <code>rake</code>
</h4><p>執行特定的 Rake 任務。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
rake "db:migrate"

</pre>
</div>
<p>可用選項有：</p>
<ul>
<li>
<code>:env</code> - 指定執行此 Rake 任務的環境。</li>
<li>
<code>:sudo</code> - 是否用 <code>sudo</code> 執行此任務，默認是 <code>false</code>。</li>
</ul>
<h4 id="capify-bang">9.14 <code>capify!</code>
</h4><p>在應用程式根目錄執行 Capistrano 的 <code>capify</code> 指令，會產生出 Capistrano 的設定檔。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
capify!

</pre>
</div>
<h4 id="route">9.15 <code>route</code>
</h4><p>新增一條路由至 <code>config/routes.rb</code>：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
route "resources :people"

</pre>
</div>
<h4 id="readme">9.16 <code>readme</code>
</h4><p>輸出模版 <code>source_path</code> 檔案的內容，通常是 <code>README</code>。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
readme "README"

</pre>
</div>


        <h3>反饋</h3>
        <p>
          歡迎幫忙改善指南的品質。
        </p>
        <p>
          如發現任何錯誤之處，歡迎修正。開始貢獻前，可以先閱讀<a href="http://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">貢獻指南：文件</a>。
        </p>
        <p>翻譯如有錯誤，深感抱歉，歡迎 <a href="https://github.com/docrails-tw/guides/fork">Fork</a> 修正，或至此處<a href="https://github.com/docsrails-tw/guides/issues/new">回報</a>。</p>
        <p>
          文章可能有未完成或過時的內容。請先檢查 <a href="http://edgeguides.rubyonrails.org">Edge Guides</a> 來確定問題在 master 是否已經修掉了。再上 master 補上缺少的文件。內容參考 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南準則</a>來了解行文風格。
        </p>
        <p>最後，任何關於 Ruby on Rails 文件的討論，歡迎至 <a href="http://groups.google.com/group/rubyonrails-docs">rubyonrails-docs 郵件論壇</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide">
  <div id="footer">
    <div class="wrapper">
      <p>本著作係採用<a href="https://creativecommons.org/licenses/by-sa/4.0/">創用 CC 姓名標示-相同方式分享 4.0 國際授權條款</a>授權。</p>
<p>“Rails”、“Ruby on Rails”，以及 Rails logo 為 David Heinemeier Hansson 的商標。版權所有。</p>

    </div>
  </div>

  <script src="javascripts/jquery.min.js"></script>
  <script src="javascripts/responsive-tables.js"></script>
  <script src="javascripts/guides.js"></script>
  <script src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,"script","//www.google-analytics.com/analytics.js","ga");

    ga("create", "UA-49903900-1", "docrails-tw.github.io");
    ga("require", "displayfeatures");
    ga("send", "pageview");

  </script>
</body>
</html>
